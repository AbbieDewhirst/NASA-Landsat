<!-- cloud_coverage.html -->
<div class="drawer-section" id="cloud-coverage-section">
    <h5>Cloud Coverage</h5>
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="enable-cloud-coverage">
        <label class="form-check-label" for="enable-cloud-coverage">Enable Cloud Coverage</label>
    </div>

    <!-- Collapsible Cloud Coverage Section -->
    <div id="cloud-coverage-collapse" class="collapse">
        <div class="mb-3">
            <label for="slider" class="form-label">Cloud Coverage</label>
            <input type="range" id="slider" class="form-range" min="0" max="100" value="50">
            <span id="slider-value">50%</span>
        </div>

        <div class="mb-3">
            <label for="start-date" class="form-label">From:</label>
            <input type="date" id="start-date" class="form-control">
        </div>
        <div class="mb-3">
            <label for="end-date" class="form-label">To:</label>
            <input type="date" id="end-date" class="form-control">
        </div>
        <button id="fetch-metadata-btn" class="btn btn-primary mb-3">Fetch Metadata</button>
        <div id="metadata-content"></div>
    </div>
</div>
<hr>

<script>
    function attachCloudCoverageListeners() {
        const enableCloudCoverage = document.getElementById('enable-cloud-coverage');
        enableCloudCoverage.addEventListener('change', (event) => {
            const isEnabled = event.target.checked;
            const cloudCoverageCollapse = document.getElementById('cloud-coverage-collapse');

            if (isEnabled) {
                new bootstrap.Collapse(cloudCoverageCollapse, { show: true });
            } else {
                new bootstrap.Collapse(cloudCoverageCollapse, { hide: true });
            }
        });

        const slider = document.getElementById('slider');
        const sliderValue = document.getElementById('slider-value');
        slider.addEventListener('input', (event) => {
            sliderValue.textContent = `${event.target.value}%`;
        });

        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        startDateInput.value = getOneMonthEarlierDateString();
        endDateInput.value = getCurrentDateString();
        startDateInput.max = getCurrentDateString();
        endDateInput.max = getCurrentDateString();

        endDateInput.addEventListener('input', () => {
            startDateInput.max = endDateInput.value;
        });

        startDateInput.addEventListener('input', () => {
            endDateInput.min = startDateInput.value;
        });

        const fetchMetadataButton = document.getElementById('fetch-metadata-btn');
        fetchMetadataButton.addEventListener('click', fetchMetadata);
    }

    function fetchMetadata() {
        const { lng, lat } = window.drawerData;
        const cloudCoverage = document.getElementById('slider').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        const metadataContent = document.getElementById('metadata-content');
        startFetchingAnimation(metadataContent);

        fetch(`/metadata?lat=${lat}&lon=${lng}&cloud_coverage=${cloudCoverage}&start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(metadata => {
                stopFetchingAnimation();
                displayMetadata(metadata);
            })
            .catch(error => {
                stopFetchingAnimation();
                console.error('Error fetching metadata:', error);
                metadataContent.innerHTML = '<p>Error fetching metadata.</p>';
            });
    }
</script>
