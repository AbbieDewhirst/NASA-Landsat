{% extends "layout.html" %}

{% block content %}

<!-- Include the drawer template -->
{% include "drawer.html" %}

<!-- Drawer toggle button -->
<button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDrawer"
    aria-controls="offcanvasDrawer" id="drawer-toggle">
    â˜°
</button>

<!-- Map container -->
<div id="map"></div>

<!-- Include the cloud slider template -->
{% include "cloud_slider.html" %}

<!-- Mapbox GL JS Initialization and Other Scripts -->
<script>
    // Mapbox GL JS initialization
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWRld2hpcnN0IiwiYSI6ImNseHZ4MXk0dDF6ZXYyanB0NGtob2Z3OXYifQ.dPt4lCIz5PLJU_sA22tvGQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-83, 42.1],
        zoom: 9
    });

    let currentMarker;
    let markersData = []; // Array to store marker data

    // Function to add a marker with a styled popup at the specified coordinates
    function addMarker(lng, lat) {
        // Remove the existing marker, if any
        if (currentMarker) {
            currentMarker.remove();
        }

        // Create a new marker
        currentMarker = new mapboxgl.Marker({ color: 'black' })
            .setLngLat([lng, lat])
            .addTo(map);

        // Store marker data
        markersData.push({ longitude: lng, latitude: lat });

        // Call the predict endpoint
        fetch(`/predict?lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                // Function to format the UTC date string to local time
                const formatDateTime = (utcString) => {
                    const date = new Date(utcString);
                    const options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZoneName: 'short' // Includes the timezone abbreviation
                    };
                    return date.toLocaleString(undefined, options);
                };

                // Format the prediction times
                const landsat8Time = formatDateTime(data["LANDSAT 8"]);
                const landsat9Time = formatDateTime(data["LANDSAT 9"]);

                // Prepare the popup content
                const popupContent = `
                    <h6 class="mb-0">Coordinates:</h6>
                    <p>Longitude: ${lng}<br>Latitude: ${lat}</p>
                    <h6 class="mb-0 pt-2">Predictions:</h6>
                    <p>LANDSAT 8: ${landsat8Time}</p>
                    <p>LANDSAT 9: ${landsat9Time}</p>
                `;

                // Set the popup with the prediction data
                const popup = new mapboxgl.Popup({ className: 'bootstrap-dark-popup' })
                    .setHTML(popupContent);

                // Attach the popup to the marker
                currentMarker.setPopup(popup);

                // Open the popup
                popup.addTo(map);
            })
            .catch(error => {
                console.error('Error fetching prediction data:', error);
                // Fallback content if there's an error
                const popupContent = `
                    <h6 class="mb-0">Coordinates:</h6>
                    <p>Longitude: ${lng}<br>Latitude: ${lat}</p>
                    <h6 class="mb-0 pt-2">Predictions:</h6>
                    <p>Error fetching prediction data.</p>
                `;

                const popup = new mapboxgl.Popup({ className: 'bootstrap-dark-popup' })
                    .setHTML(popupContent);

                currentMarker.setPopup(popup);
                popup.addTo(map);
            });
    }

    // Add marker from input
    function addMarkerFromInput() {
        const lng = parseFloat(document.getElementById('lng').value);
        const lat = parseFloat(document.getElementById('lat').value);

        if (!isNaN(lng) && !isNaN(lat)) {
            addMarker(lng, lat);
            map.flyTo({ center: [lng, lat], zoom: 12 });
        } else {
            alert('Please enter valid coordinates.');
        }
    }

    // Add marker on map click
    map.on('click', (event) => {
        const coordinates = event.lngLat;
        addMarker(coordinates.lng, coordinates.lat);

        // Update input fields
        document.getElementById('lng').value = coordinates.lng;
        document.getElementById('lat').value = coordinates.lat;
    });

    // Export data to CSV
    function exportToCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Longitude,Latitude\n";
        markersData.forEach((marker) => {
            csvContent += `${marker.longitude},${marker.latitude}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "markers_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Resize map when Offcanvas is shown or hidden
    const offcanvasDrawer = document.getElementById('offcanvasDrawer');
    offcanvasDrawer.addEventListener('shown.bs.offcanvas', () => {
        map.resize();
    });
    offcanvasDrawer.addEventListener('hidden.bs.offcanvas', () => {
        map.resize();
    });
</script>

<script>
    // Get references to the navbar collapse element and drawer toggle button
    const navbarCollapse = document.getElementById('navbarSupportedContent');
    const drawerToggleButton = document.getElementById('drawer-toggle');

    // Function to toggle the visibility of the drawer toggle button
    function toggleDrawerButton() {
        if (navbarCollapse.classList.contains('show')) {
            drawerToggleButton.style.display = 'none';
        } else {
            drawerToggleButton.style.display = 'block';
        }
    }

    // Listen for the 'shown' and 'hidden' events on the navbar collapse
    navbarCollapse.addEventListener('shown.bs.collapse', toggleDrawerButton);
    navbarCollapse.addEventListener('hidden.bs.collapse', toggleDrawerButton);

    // Initial check
    document.addEventListener('DOMContentLoaded', toggleDrawerButton);
</script>


{% endblock %}
